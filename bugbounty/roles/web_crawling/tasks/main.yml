- name: Ensure web_crawling directory exists
  become: yes
  file:
    path: "/opt/tools/web_crawling"
    state: directory

- name: Install and copy binaries
  become: yes
  vars:
    tools:
      - name: gospider
        repo: github.com/jaeles-project/gospider
      - name: hakrawler
        repo: github.com/hakluke/hakrawler
      - name: waybackurls
        repo: github.com/tomnomnom/waybackurls
      - name: katana
        repo: github.com/projectdiscovery/katana/cmd/katana
      - name: parameters
        repo: github.com/mrco24/parameters
      - name: gf
        repo: github.com/tomnomnom/gf
      - name: otx-url
        repo: github.com/mrco24/otx-url
      - name: web-archive
        repo: github.com/mrco24/web-archive

  loop: "{{ tools }}"
  block:
    - name: Install {{ item.name }}
      command: "/usr/local/go/bin/go install {{ item.repo }}@latest"
      environment:
        GOPATH: "{{ ansible_env.HOME }}/go"
        GOROOT: "/usr/local/go"
        PATH: "{{ ansible_env.PATH }}:/usr/local/go/bin:{{ ansible_env.HOME }}/go/bin"

    - name: Copy {{ item.name }} binary to /usr/local/bin
      copy:
        src: "{{ ansible_env.HOME }}/go/bin/{{ item.name }}"
        dest: "/usr/local/bin/{{ item.name }}"
        mode: "0755"

- name: Create .gf directory
  become: yes
  shell: "mkdir -p ~/.gf"
  ignore_errors: yes

- name: Install gf and its requirements
  become: yes
  block:
    - name: Install gf using git
      git:
        repo: 'https://github.com/tomnomnom/gf'
        dest: /opt/tools/web_crawling/gf

    - name: Install gf patterns
      shell: |
        cd /opt/tools/web_crawling/gf/examples/
        cp *.json ~/.gf
        cd /opt/tools/web_crawling/
        git clone https://github.com/1ndianl33t/Gf-Patterns
        cd /opt/tools/web_crawling/Gf-Patterns
        wget https://raw.githubusercontent.com/mrco24/Patterns/main/my-lfi.json
        cp *.json ~/.gf

- name: Install ParamSpider and its requirements
  become: yes
  block:
    - name: Install ParamSpider using git
      git:
        repo: 'https://github.com/devanshbatham/paramspider'
        dest: /opt/tools/web_crawling/paramspider

    - name: Install ParamSpider requirements
      pip:
        chdir: /opt/tools/web_crawling/paramspider
        virtualenv: /opt/tools/web_crawling/paramspider/env
        name: .

- name: Install Guaplus and build
  become: yes
  block:
    - name: Install Guaplus using git
      git:
        repo: 'https://github.com/bp0lr/gauplus.git'
        dest: /opt/tools/web_crawling/gauplus

    - name: Build Guaplus for ParamSpider
      shell: "cd /opt/tools/web_crawling/gauplus && go build"

    - name: Copy Guaplus binary to /usr/local/bin
      copy:
        src: "/opt/tools/web_crawling/gauplus/gauplus"
        dest: "/usr/local/bin/gauplus"
        mode: "0755"

- name: Install xnLinkFinder using pip
  become: yes
  command: "/usr/bin/python3.11 -m pip install xnLinkFinder --break-system-packages"

- name: Install freq and build
  become: yes
  block:
    - name: Install freq using git
      git:
        repo: 'https://github.com/takshal/freq.git'
        dest: /opt/tools/web_crawling/freq

    - name: Build freq
      shell: |
        cd /opt/tools/web_crawling/freq/
        mv main.go freq.go
        go build freq.go
        cp freq /usr/bin
